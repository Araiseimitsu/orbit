{% extends "base.html" %}

{% block title %}{{ page_title }} - ORBIT{% endblock %}

{% block head %}
    <link rel="stylesheet" href="/static/flow-editor.css?v={{ static_version }}">
{% endblock %}

{% block content %}
<div class="flow-editor-page">
    <div class="flow-editor-header">
        <div class="header-left">
            <div class="header-field">
                <label for="workflow-name">ワークフロー名</label>
                <input id="workflow-name" type="text" placeholder="例: hello_world">
            </div>
            <div class="header-field">
                <label for="trigger-type">トリガー</label>
                <select id="trigger-type">
                    <option value="manual">手動実行</option>
                    <option value="schedule">スケジュール実行</option>
                </select>
            </div>
            <div class="header-field">
                <label for="workflow-enabled">状態</label>
                <label class="inline-flex items-center gap-2 text-sm text-gray-600">
                    <input id="workflow-enabled" type="checkbox" class="h-4 w-4">
                    アクティブ
                </label>
            </div>
            <div class="header-field" id="cron-field">
                <div class="cron-col">
                    <label for="trigger-cron">cron</label>
                    <input id="trigger-cron" type="text" placeholder="0 9 * * *">
                </div>
                <div class="cron-col">
                    <label for="cron-preset" class="cron-sub-label">プリセット</label>
                    <select id="cron-preset">
                        <option value="">選択してください</option>
                        <option value="*/1 * * * *">毎分</option>
                        <option value="*/5 * * * *">5分ごと</option>
                        <option value="0 * * * *">毎時（毎時00分）</option>
                        <option value="0 9 * * *">毎日 9:00</option>
                        <option value="0 9 * * 1-5">平日 9:00</option>
                        <option value="0 9 * * 0">毎週日曜 9:00</option>
                    </select>
                </div>
                <div id="cron-preview" class="cron-preview"></div>
                <div id="cron-error" class="cron-error"></div>
                <div class="cron-help">
                    形式: 分(0-59) 時(0-23) 日(1-31) 月(1-12) 曜日(0-6/SUN-SAT)
                </div>
                <div class="cron-help">
                    * = すべて / */n = nごと（例: */5 * * * * = 5分ごと） ※タイムゾーンはJST固定
                </div>
            </div>
        </div>
        <div class="header-right">
            <span class="header-status" id="editor-status"></span>
            <button class="primary-button" id="save-workflow">保存</button>
        </div>
    </div>

    <section class="flow-ai-panel">
        <div class="flow-ai-head">
            <div>
                <div class="flow-ai-title">AI フロー自動構築</div>
                <div class="flow-ai-sub">やりたいことを文章で入力すると、AI がステップ構成を提案します。</div>
            </div>
            <div class="flow-ai-controls">
                <select id="ai-flow-mode">
                    <option value="replace">現在のフローを置き換え</option>
                    <option value="append">末尾に追加</option>
                </select>
                <label class="ai-search-toggle">
                    <input id="ai-flow-search" type="checkbox">
                    Web検索
                </label>
                <button class="primary-button" id="ai-flow-generate" type="button">AIで構築</button>
            </div>
        </div>
        <div class="flow-ai-body">
            <textarea id="ai-flow-prompt" placeholder="例: 毎朝9時に実行。Excel: C:\\data\\sales.xlsx の sheet=売上 を A1:D200 で読み取り、合計/平均との差分を要約して ARAICHAT ルーム番号 12345 に送信。メッセージタイトルは『日次レポート』。条件: 合計が100000以上の時のみ送信。出力キーは text を使用。できるだけ詳しく書くと、その内容に沿って作成されます（ファイルパス、ルーム番号、シート名、範囲、条件など）。"></textarea>
        </div>
        <div class="flow-ai-footer">
            <div id="ai-flow-status" class="flow-ai-status"></div>
            <button class="ghost-button" id="ai-flow-clear" type="button">クリア</button>
        </div>
    </section>

    {% if error %}
    <div class="flow-editor-error">
        <strong>読み込みエラー:</strong>
        <span>{{ error }}</span>
    </div>
    {% endif %}

    <div class="flow-editor-layout">
        <aside class="flow-panel">
            <div class="panel-title">アクション</div>
            <div id="action-list" class="action-list"></div>
        </aside>

        <section class="flow-canvas-wrap">
            <div class="canvas-toolbar">
                <span class="hint">左のアクションから追加 / ドラッグで移動 / クリックで編集（実行順は上から下）</span>
                <div class="canvas-zoom-controls">
                    <button class="zoom-button" id="zoom-out" title="縮小">−</button>
                    <span class="zoom-level" id="zoom-level">100%</span>
                    <button class="zoom-button" id="zoom-in" title="拡大">+</button>
                    <button class="zoom-button" id="zoom-reset" title="リセット">⟲</button>
                </div>
            </div>
            <div id="flow-canvas" class="flow-canvas"></div>
        </section>

        <aside class="flow-panel">
            <div class="panel-title">詳細</div>
            <div id="inspector" class="inspector"></div>
        </aside>
    </div>
</div>

<script id="flow-editor-config" type="application/json">{{ config_json | safe }}</script>
{% endblock %}

{% block scripts %}
    <script src="/static/flow-editor.js?v={{ static_version }}" defer></script>
{% endblock %}
