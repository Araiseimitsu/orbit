{% extends "base.html" %} {% block title %}Runs - ORBIT{% endblock %} {% block
content %}
<div class="mb-12">
    <h1 class="text-4xl font-extrabold tracking-tight text-white mb-2">
        Execution History
    </h1>
    <p class="text-gray-500 font-medium">
        Monitor and audit all workflow runs.
    </p>
</div>

<div class="apple-card p-5 mb-8">
    <form method="get" class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
            <label for="workflow-filter" class="text-xs font-semibold text-gray-400 uppercase tracking-widest">
                Workflow
            </label>
            <select id="workflow-filter" name="workflow"
                class="w-full sm:w-64 bg-white/5 text-white border border-white/10 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/40">
                <option value="">All workflows</option>
                {% for wf in workflow_options %}
                <option value="{{ wf }}" {% if workflow_filter == wf %}selected{% endif %}>{{ wf }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="flex items-center gap-2">
            <button type="submit" class="apple-button apple-button-primary px-5 py-2 text-xs">
                Filter
            </button>
            {% if workflow_filter %}
            <a href="/runs" class="apple-button apple-button-secondary px-5 py-2 text-xs">
                Clear
            </a>
            {% endif %}
        </div>
    </form>
    {% if workflow_filter %}
    <p class="mt-3 text-xs text-gray-500">
        Filtering by <span class="text-white font-semibold">{{ workflow_filter }}</span>
    </p>
    {% endif %}
</div>

<div class="space-y-4">
    {% if runs %} {% for run in runs %}
    <div class="apple-card overflow-hidden">
        <!-- Header section of the run card -->
        <div
            class="flex items-center justify-between p-5 bg-white/5 border-b border-white/5"
        >
            <div class="flex items-center space-x-4">
                <span
                    class="apple-badge {% if run.status == 'success' %}badge-success{% elif run.status == 'failed' %}badge-error{% else %}badge-pending{% endif %}"
                >
                    {{ run.status }}
                </span>
                <div class="flex flex-col">
                    <span class="text-sm font-bold text-white leading-tight"
                        >{{ run.workflow }}</span
                    >
                    <span
                        class="text-[10px] font-mono text-gray-500 uppercase tracking-widest mt-0.5"
                        >{{ run.run_id }}</span
                    >
                </div>
            </div>
            <div class="flex items-center space-x-6 text-xs font-medium">
                <div class="hidden md:flex flex-col items-end">
                    <span
                        class="text-gray-500 uppercase text-[9px] tracking-tighter mb-0.5"
                        >Started At</span
                    >
                    <span class="text-gray-300">{{ run.started_at }}</span>
                </div>
                <button
                    type="button"
                    data-run-details-toggle="{{ run.run_id }}"
                    aria-controls="details-{{ run.run_id }}"
                    aria-expanded="false"
                    class="apple-button apple-button-secondary px-4 py-2 text-[11px]"
                >
                    View Details
                </button>
            </div>
        </div>

        <!-- Detailed section (Hidden by default) -->
        <div id="details-{{ run.run_id }}" class="hidden p-6 bg-black/40">
            <div class="grid md:grid-cols-2 gap-8">
                <!-- Left: Metadata -->
                <div class="space-y-6">
                    <div>
                        <h4
                            class="text-[10px] uppercase tracking-widest text-gray-500 font-bold mb-3"
                        >
                            Runtime Info
                        </h4>
                        <div class="space-y-2">
                            <div
                                class="flex justify-between py-1.5 border-b border-white/5"
                            >
                                <span class="text-xs text-gray-400"
                                    >Duration</span
                                >
                                <span class="text-xs text-white">
                                    {% if run.ended_at %} Completed {% else %}
                                    In Progress {% endif %}
                                </span>
                            </div>
                            <div
                                class="flex justify-between py-1.5 border-b border-white/5"
                            >
                                <span class="text-xs text-gray-400"
                                    >Status</span
                                >
                                <span
                                    class="text-xs {% if run.status == 'success' %}text-green-400{% elif run.status == 'stopped' %}text-amber-400{% else %}text-red-400{% endif %} font-bold"
                                    >{{ run.status | upper }}</span
                                >
                            </div>
                        </div>
                    </div>

                    {% if run.error %}
                    <div
                        class="p-4 bg-red-500/10 border border-red-500/20 rounded-xl"
                    >
                        <h4
                            class="text-[10px] uppercase tracking-widest text-red-400 font-bold mb-2"
                        >
                            Error Trace
                        </h4>
                        <pre
                            class="text-[11px] text-red-300 whitespace-pre-wrap font-mono"
                        >
{{ run.error }}</pre
                        >
                    </div>
                    {% endif %}
                </div>

                <!-- Right: Step Execution -->
                <div>
                    <h4
                        class="text-[10px] uppercase tracking-widest text-gray-500 font-bold mb-3"
                    >
                        Step Details
                    </h4>
                    <div class="space-y-2">
                        {% if run.steps %} {% for step_result in run.steps %}
                        <div
                            class="p-3 bg-white/5 rounded-lg border border-white/5"
                        >
                            <div class="flex items-center justify-between">
                                <span class="text-xs font-bold text-gray-200"
                                    >{{ step_result.id }}</span
                                >
                                <span
                                    class="{% if step_result.status == 'success' %}text-green-500{% elif step_result.status == 'skipped' %}text-gray-400{% else %}text-red-500{% endif %} text-[10px] font-bold"
                                >
                                    {{ step_result.status | upper }}
                                </span>
                            </div>
                            {% if step_result.result %}
                            <details class="mt-2 group">
                                <summary
                                    class="text-[10px] text-gray-500 cursor-pointer hover:text-blue-400 transition-colors uppercase font-bold tracking-tighter"
                                >
                                    View Output
                                </summary>
                                <pre
                                    class="mt-2 p-3 bg-black/60 text-gray-300 text-[10px] rounded-lg overflow-x-auto ring-1 ring-white/5 font-mono"
                                >
{{ step_result.result | tojson_utf8(indent=2) }}</pre
                                >
                            </details>
                            {% endif %}
                        </div>
                        {% endfor %} {% else %}
                        <p class="text-[11px] text-gray-600 italic">
                            No individual step data available.
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="mt-8 pt-6 border-t border-white/5">
                <details class="group">
                    <summary
                        class="text-[10px] text-gray-600 cursor-pointer hover:text-gray-400 transition-colors uppercase font-bold tracking-widest"
                    >
                        Raw System Output
                    </summary>
                    <pre
                        class="mt-4 p-4 bg-black/80 text-blue-300 text-[10px] rounded-xl overflow-x-auto font-mono ring-1 ring-blue-500/20"
                    >
{{ run.model_dump() | tojson_utf8(indent=2) }}</pre
                    >
                </details>
            </div>
        </div>
    </div>
    {% endfor %} {% else %}
    <div class="apple-card p-20 text-center">
        <div
            class="w-16 h-16 bg-white/5 rounded-2xl flex items-center justify-center mx-auto mb-6"
        >
            <svg
                class="w-8 h-8 text-gray-400"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                />
            </svg>
        </div>
        <h3 class="text-xl font-bold text-white mb-2">No execution history</h3>
        <p class="text-gray-500">
            Run a workflow to see its execution records here.
        </p>
    </div>
    {% endif %}
</div>

<!-- ページネーション -->
{% if pagination and pagination.total_pages > 1 %}
<div class="apple-card mt-8">
    <div class="flex items-center justify-between p-6">
        <div class="text-xs text-gray-500">
            Showing {{ (pagination.page - 1) * pagination.per_page + 1 }}-{{ pagination.page * pagination.per_page if pagination.page * pagination.per_page < pagination.total else pagination.total }} of {{ pagination.total }} runs
        </div>
        <div class="flex items-center space-x-2">
            {% if pagination.has_prev %}
            <a href="/runs?{% if workflow_filter %}workflow={{ workflow_filter }}&{% endif %}page={{ pagination.page - 1 }}"
                class="px-4 py-2 text-xs font-medium text-gray-400 hover:text-white bg-white/5 hover:bg-white/10 rounded-lg transition-colors">
                Previous
            </a>
            {% endif %}

            <div class="flex items-center space-x-1">
                {% for p in range(1, pagination.total_pages + 1) %}
                    {% if p == pagination.page %}
                    <span class="px-4 py-2 text-xs font-bold text-white bg-blue-500 rounded-lg">{{ p }}</span>
                    {% elif p == 1 or p == pagination.total_pages or (p >= pagination.page - 2 and p <= pagination.page + 2) %}
                    <a href="/runs?{% if workflow_filter %}workflow={{ workflow_filter }}&{% endif %}page={{ p }}"
                        class="px-4 py-2 text-xs font-medium text-gray-400 hover:text-white bg-white/5 hover:bg-white/10 rounded-lg transition-colors">{{ p }}</a>
                    {% elif p == pagination.page - 3 or p == pagination.page + 3 %}
                    <span class="px-2 text-xs text-gray-600">...</span>
                    {% endif %}
                {% endfor %}
            </div>

            {% if pagination.has_next %}
            <a href="/runs?{% if workflow_filter %}workflow={{ workflow_filter }}&{% endif %}page={{ pagination.page + 1 }}"
                class="px-4 py-2 text-xs font-medium text-gray-400 hover:text-white bg-white/5 hover:bg-white/10 rounded-lg transition-colors">
                Next
            </a>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}
{% endblock %} {% block scripts %}{% endblock %}
